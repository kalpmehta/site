<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Multiple Shipments on KALPESH MEHTA</title>
    <link>http://localhost:1313/blog/multiple-shipments/</link>
    <description>Recent content in Multiple Shipments on KALPESH MEHTA</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-US</language>
    <managingEditor>k@lpe.sh (Kalpesh Mehta)</managingEditor>
    <webMaster>k@lpe.sh (Kalpesh Mehta)</webMaster>
    <copyright>Copyright © 2025 kalpesh mehta</copyright>
    <lastBuildDate>Tue, 17 Jan 2012 17:17:39 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/blog/multiple-shipments/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Magento: Linking multiple shipments with their invoices</title>
      <link>http://localhost:1313/magento-linking-multiple-shipments-with-their-invoices/</link>
      <pubDate>Tue, 17 Jan 2012 17:17:39 +0000</pubDate><author>k@lpe.sh (Kalpesh Mehta)</author>
      <guid>http://localhost:1313/magento-linking-multiple-shipments-with-their-invoices/</guid>
      <description>&lt;p&gt;In Magento, it’s a feature to create multiple invoices and shipments. But you can’t find the link between invoice with their respective shipment if you have more than one invoice and shipment. It’s because if you have forced invoice and shipment enabled (Invoice and Ship button combined in Manage Orders view page), it saves both invoice and shipment object together and hence can’t give the invoice id to shipment and hence fails in building the link between them.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>In Magento, it’s a feature to create multiple invoices and shipments. But you can’t find the link between invoice with their respective shipment if you have more than one invoice and shipment. It’s because if you have forced invoice and shipment enabled (Invoice and Ship button combined in Manage Orders view page), it saves both invoice and shipment object together and hence can’t give the invoice id to shipment and hence fails in building the link between them.</p>
<p>So what we need to do here is:<br>
1. Add a column to sales_flat_shipment which will store invoice increment id (say invoice_id)<br>
2. Before invoice and shipment are saved, get the invoice’s latest increment id and increment it by 1 (to get next invoice increment id)<br>
3. Give that invoice increment id to shipment object, so it will get saved along with other shipment columns</p>
<p>Here we go technically,</p>
<p>Firstly, add a column to sales_flat_shipment table.<br>




<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php <span style="color:#b8860b">$installer</span> <span style="color:#666">=</span> <span style="color:#b8860b">$this</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$installer</span><span style="color:#666">-&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">startSetup</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$installer</span><span style="color:#666">-&gt;</span><span style="color:#b44">run</span>(”  
</span></span><span style="display:flex;"><span>ALTER TABLE sales_flat_shipment ADD COLUMN invoice_id VARCHAR(<span style="color:#666">50</span>) AFTER increment_id  
</span></span><span style="display:flex;"><span>“);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$installer</span><span style="color:#666">-&gt;</span><span style="color:#b44">endSetup</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080">?&gt;</span><span style="">
</span></span></span></code></pre></div></p>
<p>Then, override InvoiceController.php of sales/order: Mage/Adminhtml/controllers/Sales/Order/InvoiceController.php<br>
Paste this code to newly overridden file:</p>




<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#666">&lt;?</span>php <span style="color:#a2f;font-weight:bold">require_once</span>(<span style="color:#b44">&#39;Mage/Adminhtml/controllers/Sales/Order/InvoiceController.php&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">Namespace_Module_Sales_Order_InvoiceController</span> <span style="color:#a2f;font-weight:bold">extends</span> Mage_Adminhtml_Sales_Order_InvoiceController
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#b44;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic">     * @author - Kalpesh Mehta
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic">     * @desc - Rewritten this method for linking shipment and invoice
</span></span></span><span style="display:flex;"><span><span style="color:#b44;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">function</span> <span style="color:#00a000">saveAction</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#b8860b">$data</span> <span style="color:#666">=</span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#b44">getRequest</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">getPost</span>(‘invoice’);  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$orderId</span> <span style="color:#666">=</span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">getRequest</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">getParam</span>(‘order_id’);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘comment_text’])) {  
</span></span><span style="display:flex;"><span> Mage<span style="color:#666">::</span><span style="color:#b44">getSingleton</span>(‘adminhtml<span style="color:#666">/</span>session’)<span style="color:#666">-&gt;</span><span style="color:#b44">setCommentText</span>(<span style="color:#b8860b">$data</span>[‘comment_text’]);  
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">try</span> {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span> <span style="color:#666">=</span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_initInvoice</span>();  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#b8860b">$invoice</span>) {  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘capture_case’])) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">setRequestedCaptureCase</span>(<span style="color:#b8860b">$data</span>[‘capture_case’]);  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘comment_text’])) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">addComment</span>(<span style="color:#b8860b">$data</span>[‘comment_text’], isset(<span style="color:#b8860b">$data</span>[‘comment_customer_notify’]), isset(<span style="color:#b8860b">$data</span>[‘is_visible_on_front’]));  
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">register</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘send_email’])) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">setEmailSent</span>(<span style="color:#a2f;font-weight:bold">true</span>);  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">getOrder</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">setCustomerNoteNotify</span>(<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘send_email’]));  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">getOrder</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">setIsInProcess</span>(<span style="color:#a2f;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$transactionSave</span> <span style="color:#666">=</span> Mage<span style="color:#666">::</span><span style="color:#b44">getModel</span>(‘core<span style="color:#666">/</span>resource_transaction’)  
</span></span><span style="display:flex;"><span> <span style="color:#666">-&gt;</span><span style="color:#b44">addObject</span>(<span style="color:#b8860b">$invoice</span>)  
</span></span><span style="display:flex;"><span> <span style="color:#666">-&gt;</span><span style="color:#b44">addObject</span>(<span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">getOrder</span>());  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$shipment</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘do_shipment’]) <span style="color:#666">||</span> (int) <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">getOrder</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">getForcedDoShipmentWithInvoice</span>()) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$shipment</span> <span style="color:#666">=</span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_prepareShipment</span>(<span style="color:#b8860b">$invoice</span>);  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#b8860b">$shipment</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#080;font-style:italic">//Get last invoice increment ID  
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span> <span style="color:#b8860b">$invoiceLast</span> <span style="color:#666">=</span> Mage<span style="color:#666">::</span><span style="color:#b44">getModel</span>(‘sales<span style="color:#666">/</span>order_invoice’)<span style="color:#666">-&gt;</span><span style="color:#b44">getCollection</span>()  
</span></span><span style="display:flex;"><span> <span style="color:#666">-&gt;</span><span style="color:#b44">setOrder</span>(‘increment_id’,’DESC’)  
</span></span><span style="display:flex;"><span> <span style="color:#666">-&gt;</span><span style="color:#b44">setPageSize</span>(<span style="color:#666">1</span>)  
</span></span><span style="display:flex;"><span> <span style="color:#666">-&gt;</span><span style="color:#b44">setCurPage</span>(<span style="color:#666">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invLastIncrId</span> <span style="color:#666">=</span> <span style="color:#b8860b">$invoiceLast</span><span style="color:#666">-&gt;</span><span style="color:#b44">getFirstItem</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">getIncrementId</span>();  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invNewIncrId</span> <span style="color:#666">=</span> (int)<span style="color:#b8860b">$invLastIncrId</span> <span style="color:#666">+</span> <span style="color:#666">1</span>; <span style="color:#080;font-style:italic">//incrementing by 1  
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span> <span style="color:#b8860b">$shipment</span><span style="color:#666">-&gt;</span><span style="color:#b44">setInvoiceId</span>(<span style="color:#b8860b">$invNewIncrId</span>); <span style="color:#080;font-style:italic">//setting data for our sales_flat_shipment table column invoice_id
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$shipment</span><span style="color:#666">-&gt;</span><span style="color:#b44">setEmailSent</span>(<span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">getEmailSent</span>());  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$transactionSave</span><span style="color:#666">-&gt;</span><span style="color:#b44">addObject</span>(<span style="color:#b8860b">$shipment</span>);  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$transactionSave</span><span style="color:#666">-&gt;</span><span style="color:#b44">save</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘do_shipment’]) <span style="color:#666">||</span> (int) <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">getOrder</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">getForcedDoShipmentWithInvoice</span>()) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_getSession</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">addSuccess</span>(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">__</span>(‘The invoice <span style="color:#a2f;font-weight:bold">and</span> shipment have been created<span style="color:#666">.</span>’));  
</span></span><span style="display:flex;"><span> } <span style="color:#a2f;font-weight:bold">else</span> {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_getSession</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">addSuccess</span>(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">__</span>(‘The invoice has been created<span style="color:#666">.</span>’));  
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#080;font-style:italic">// send invoice/shipment emails  
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span> <span style="color:#b8860b">$comment</span> <span style="color:#666">=</span> ”;  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (isset(<span style="color:#b8860b">$data</span>[‘comment_customer_notify’])) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$comment</span> <span style="color:#666">=</span> <span style="color:#b8860b">$data</span>[‘comment_text’];  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">try</span> {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$invoice</span><span style="color:#666">-&gt;</span><span style="color:#b44">sendEmail</span>(<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘send_email’]), <span style="color:#b8860b">$comment</span>);  
</span></span><span style="display:flex;"><span> } <span style="color:#a2f;font-weight:bold">catch</span> (Exception <span style="color:#b8860b">$e</span>) {  
</span></span><span style="display:flex;"><span> Mage<span style="color:#666">::</span><span style="color:#b44">logException</span>(<span style="color:#b8860b">$e</span>);  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_getSession</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">addError</span>(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">__</span>(‘Unable to send the invoice email<span style="color:#666">.</span>’));  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">if</span> (<span style="color:#b8860b">$shipment</span>) {  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">try</span> {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$shipment</span><span style="color:#666">-&gt;</span><span style="color:#b44">sendEmail</span>(<span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">empty</span>(<span style="color:#b8860b">$data</span>[‘send_email’]));  
</span></span><span style="display:flex;"><span> } <span style="color:#a2f;font-weight:bold">catch</span> (Exception <span style="color:#b8860b">$e</span>) {  
</span></span><span style="display:flex;"><span> Mage<span style="color:#666">::</span><span style="color:#b44">logException</span>(<span style="color:#b8860b">$e</span>);  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_getSession</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">addError</span>(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">__</span>(‘Unable to send the shipment email<span style="color:#666">.</span>’));  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> Mage<span style="color:#666">::</span><span style="color:#b44">getSingleton</span>(‘adminhtml<span style="color:#666">/</span>session’)<span style="color:#666">-&gt;</span><span style="color:#b44">getCommentText</span>(<span style="color:#a2f;font-weight:bold">true</span>);  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_redirect</span>(‘<span style="color:#666">*/</span>sales_order<span style="color:#666">/</span>view’, <span style="color:#a2f;font-weight:bold">array</span>(‘order_id’ <span style="color:#666">=&gt;</span> <span style="color:#b8860b">$orderId</span>));  
</span></span><span style="display:flex;"><span> } <span style="color:#a2f;font-weight:bold">else</span> {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_redirect</span>(‘<span style="color:#666">*/*/</span><span style="color:#a2f;font-weight:bold">new</span>’, <span style="color:#a2f;font-weight:bold">array</span>(‘order_id’ <span style="color:#666">=&gt;</span> <span style="color:#b8860b">$orderId</span>));  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">return</span>;  
</span></span><span style="display:flex;"><span> } <span style="color:#a2f;font-weight:bold">catch</span> (Mage_Core_Exception <span style="color:#b8860b">$e</span>) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_getSession</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">addError</span>(<span style="color:#b8860b">$e</span><span style="color:#666">-&gt;</span><span style="color:#b44">getMessage</span>());  
</span></span><span style="display:flex;"><span> } <span style="color:#a2f;font-weight:bold">catch</span> (Exception <span style="color:#b8860b">$e</span>) {  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_getSession</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">addError</span>(<span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">__</span>(‘Unable to save the invoice<span style="color:#666">.</span>’));  
</span></span><span style="display:flex;"><span> Mage<span style="color:#666">::</span><span style="color:#b44">logException</span>(<span style="color:#b8860b">$e</span>);  
</span></span><span style="display:flex;"><span> }  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">_redirect</span>(‘<span style="color:#666">*/*/</span><span style="color:#a2f;font-weight:bold">new</span>’, <span style="color:#a2f;font-weight:bold">array</span>(‘order_id’ <span style="color:#666">=&gt;</span> <span style="color:#b8860b">$orderId</span>));  
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
]]></content:encoded>
    </item>
  </channel>
</rss>
