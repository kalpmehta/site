<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Pickup Report on KALPESH MEHTA</title>
    <link>http://localhost:1313/blog/pickup-report/</link>
    <description>Recent content in Pickup Report on KALPESH MEHTA</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-US</language>
    <managingEditor>k@lpe.sh (Kalpesh Mehta)</managingEditor>
    <webMaster>k@lpe.sh (Kalpesh Mehta)</webMaster>
    <copyright>Copyright © 2025 kalpesh mehta</copyright>
    <lastBuildDate>Sat, 31 Dec 2011 11:09:45 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/blog/pickup-report/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Magento: Joining/group by &amp;#8211; order, invoice, shipment tables</title>
      <link>http://localhost:1313/magento-joining/group-by-%238211-order-invoice-shipment-tables/</link>
      <pubDate>Sat, 31 Dec 2011 11:09:45 +0000</pubDate><author>k@lpe.sh (Kalpesh Mehta)</author>
      <guid>http://localhost:1313/magento-joining/group-by-%238211-order-invoice-shipment-tables/</guid>
      <description>&lt;p&gt;Ever tried to join multiple tables in Magento? Joining and grouping tables is not that easy in Magento ORM than in simple MySql way we did for years.&lt;/p&gt;&#xA;&lt;p&gt;Here is a piece of code where I was required to grab all the data from orders, invoices, shipments to generate reports for warehouse people to make their life easier.&lt;/p&gt;&#xA;&#xA;&#xA;&#xA;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt; &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; Mage&lt;span style=&#34;color:#666&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getResourceModel&lt;/span&gt;(‘sales&lt;span style=&#34;color:#666&#34;&gt;/&lt;/span&gt;order_shipment_item_collection’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;addFieldToSelect&lt;/span&gt;(‘section_id’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;addFieldToSelect&lt;/span&gt;(‘shelf_id’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;addFieldToSelect&lt;/span&gt;(‘rack_id’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;addFieldToSelect&lt;/span&gt;(‘box_id’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;//$collection-&amp;gt;addFieldToSelect(‘GROUP_CONCAT(DISTINCT main_table.product_id SEPARATOR “,”)’,’product_ids’);&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_shipment_grid’, ‘main_table&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;parent_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_shipment_grid&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;entity_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘increment_id &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; shipment_increment_id’, ‘created_at &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; shipment_created_at’, ‘order_increment_id’,’total_qty’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_shipment_track’, ‘sales_flat_shipment_grid&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;entity_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_shipment_track&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;parent_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘number &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; track_id’, ‘carrier_code &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; carrier_name’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_order’, ‘sales_flat_shipment_track&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;order_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_order&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;entity_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘created_at &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; order_created_at’,’grand_total &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; ord_grand_total’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_order_item’, ‘main_table&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;order_item_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_order_item&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;item_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘product_type’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_order_payment’, ‘sales_flat_shipment_track&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;order_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_order_payment&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;parent_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘method &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;as&lt;/span&gt; payment_method’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_order_address’, ‘sales_flat_shipment_track&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;order_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_order_address&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;parent_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘firstname’,’lastname’,’street’,’city’,’postcode’,’region’,’telephone’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;joinLeft&lt;/span&gt;(‘sales_flat_invoice’, ‘sales_flat_shipment_track&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;order_id &lt;span style=&#34;color:#666&#34;&gt;=&lt;/span&gt; sales_flat_invoice&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;order_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘grand_total’));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;//$collection-&amp;gt;addAttributeToFilter(‘main_table.price’, array(‘gt’ =&amp;gt; 0));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#b8860b&#34;&gt;$pickup_ids&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;!=&lt;/span&gt;” &lt;span style=&#34;color:#666&#34;&gt;&amp;amp;&lt;/span&gt;amp;&lt;span style=&#34;color:#666&#34;&gt;&amp;amp;&lt;/span&gt;amp; is_array(&lt;span style=&#34;color:#b8860b&#34;&gt;$pickup_ids&lt;/span&gt;))  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; &lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;addAttributeToFilter&lt;/span&gt;(‘sales_flat_shipment_grid&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;entity_id’, &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘in’ &lt;span style=&#34;color:#666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#b8860b&#34;&gt;$pickup_ids&lt;/span&gt;));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;columns&lt;/span&gt;(  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘product_ids’ &lt;span style=&#34;color:#666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;new&lt;/span&gt; Zend_Db_Expr(  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; “IFNULL(GROUP_CONCAT(DISTINCT main_table&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;product_id SEPARATOR ‘;’), ”)”  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;)));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;columns&lt;/span&gt;(  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;array&lt;/span&gt;(‘weight’ &lt;span style=&#34;color:#666&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span style=&#34;color:#a2f;font-weight:bold&#34;&gt;new&lt;/span&gt; Zend_Db_Expr(  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt; “IFNULL(SUM(main_table&lt;span style=&#34;color:#666&#34;&gt;.&lt;/span&gt;weight)&lt;span style=&#34;color:#666&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;2&lt;/span&gt;, ”)”  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;)));  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;getSelect&lt;/span&gt;()&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;group&lt;/span&gt;(‘shipment_increment_id’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;//$collection-&amp;gt;getSelect()-&amp;gt;group(‘track_id’);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;//Mage::log($collection-&amp;gt;getSelect()-&amp;gt;__toString());  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#b8860b&#34;&gt;$this&lt;/span&gt;&lt;span style=&#34;color:#666&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#b44&#34;&gt;setCollection&lt;/span&gt;(&lt;span style=&#34;color:#b8860b&#34;&gt;$collection&lt;/span&gt;);  &#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#080;font-style:italic&#34;&gt;//$this-&amp;gt;getCollection()-&amp;gt;getSelect()-&amp;gt;limit();&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&#xA;&lt;p&gt;Although the query is so expensive, I have not yet tried to optimize it due to lack of time.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>Ever tried to join multiple tables in Magento? Joining and grouping tables is not that easy in Magento ORM than in simple MySql way we did for years.</p>
<p>Here is a piece of code where I was required to grab all the data from orders, invoices, shipments to generate reports for warehouse people to make their life easier.</p>




<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#b8860b">$collection</span> <span style="color:#666">=</span> Mage<span style="color:#666">::</span><span style="color:#b44">getResourceModel</span>(‘sales<span style="color:#666">/</span>order_shipment_item_collection’);  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">addFieldToSelect</span>(‘section_id’);  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">addFieldToSelect</span>(‘shelf_id’);  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">addFieldToSelect</span>(‘rack_id’);  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">addFieldToSelect</span>(‘box_id’);  
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//$collection-&gt;addFieldToSelect(‘GROUP_CONCAT(DISTINCT main_table.product_id SEPARATOR “,”)’,’product_ids’);
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_shipment_grid’, ‘main_table<span style="color:#666">.</span>parent_id <span style="color:#666">=</span> sales_flat_shipment_grid<span style="color:#666">.</span>entity_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘increment_id <span style="color:#a2f;font-weight:bold">as</span> shipment_increment_id’, ‘created_at <span style="color:#a2f;font-weight:bold">as</span> shipment_created_at’, ‘order_increment_id’,’total_qty’));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_shipment_track’, ‘sales_flat_shipment_grid<span style="color:#666">.</span>entity_id <span style="color:#666">=</span> sales_flat_shipment_track<span style="color:#666">.</span>parent_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘number <span style="color:#a2f;font-weight:bold">as</span> track_id’, ‘carrier_code <span style="color:#a2f;font-weight:bold">as</span> carrier_name’));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_order’, ‘sales_flat_shipment_track<span style="color:#666">.</span>order_id <span style="color:#666">=</span> sales_flat_order<span style="color:#666">.</span>entity_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘created_at <span style="color:#a2f;font-weight:bold">as</span> order_created_at’,’grand_total <span style="color:#a2f;font-weight:bold">as</span> ord_grand_total’));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_order_item’, ‘main_table<span style="color:#666">.</span>order_item_id <span style="color:#666">=</span> sales_flat_order_item<span style="color:#666">.</span>item_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘product_type’));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_order_payment’, ‘sales_flat_shipment_track<span style="color:#666">.</span>order_id <span style="color:#666">=</span> sales_flat_order_payment<span style="color:#666">.</span>parent_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘method <span style="color:#a2f;font-weight:bold">as</span> payment_method’));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_order_address’, ‘sales_flat_shipment_track<span style="color:#666">.</span>order_id <span style="color:#666">=</span> sales_flat_order_address<span style="color:#666">.</span>parent_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘firstname’,’lastname’,’street’,’city’,’postcode’,’region’,’telephone’));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">joinLeft</span>(‘sales_flat_invoice’, ‘sales_flat_shipment_track<span style="color:#666">.</span>order_id <span style="color:#666">=</span> sales_flat_invoice<span style="color:#666">.</span>order_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘grand_total’));  
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//$collection-&gt;addAttributeToFilter(‘main_table.price’, array(‘gt’ =&gt; 0));  
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#a2f;font-weight:bold">if</span>(<span style="color:#b8860b">$pickup_ids</span><span style="color:#666">!=</span>” <span style="color:#666">&amp;</span>amp;<span style="color:#666">&amp;</span>amp; is_array(<span style="color:#b8860b">$pickup_ids</span>))  
</span></span><span style="display:flex;"><span> <span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">addAttributeToFilter</span>(‘sales_flat_shipment_grid<span style="color:#666">.</span>entity_id’, <span style="color:#a2f;font-weight:bold">array</span>(‘in’ <span style="color:#666">=&gt;</span> <span style="color:#b8860b">$pickup_ids</span>));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">columns</span>(  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">array</span>(‘product_ids’ <span style="color:#666">=&gt;</span> <span style="color:#a2f;font-weight:bold">new</span> Zend_Db_Expr(  
</span></span><span style="display:flex;"><span> “IFNULL(GROUP_CONCAT(DISTINCT main_table<span style="color:#666">.</span>product_id SEPARATOR ‘;’), ”)”  
</span></span><span style="display:flex;"><span>)));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">columns</span>(  
</span></span><span style="display:flex;"><span> <span style="color:#a2f;font-weight:bold">array</span>(‘weight’ <span style="color:#666">=&gt;</span> <span style="color:#a2f;font-weight:bold">new</span> Zend_Db_Expr(  
</span></span><span style="display:flex;"><span> “IFNULL(SUM(main_table<span style="color:#666">.</span>weight)<span style="color:#666">/</span><span style="color:#666">2</span>, ”)”  
</span></span><span style="display:flex;"><span>)));  
</span></span><span style="display:flex;"><span><span style="color:#b8860b">$collection</span><span style="color:#666">-&gt;</span><span style="color:#b44">getSelect</span>()<span style="color:#666">-&gt;</span><span style="color:#b44">group</span>(‘shipment_increment_id’);  
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//$collection-&gt;getSelect()-&gt;group(‘track_id’);  
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//Mage::log($collection-&gt;getSelect()-&gt;__toString());  
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span><span style="color:#b8860b">$this</span><span style="color:#666">-&gt;</span><span style="color:#b44">setCollection</span>(<span style="color:#b8860b">$collection</span>);  
</span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic">//$this-&gt;getCollection()-&gt;getSelect()-&gt;limit();
</span></span></span></code></pre></div>
<p>Although the query is so expensive, I have not yet tried to optimize it due to lack of time.</p>
]]></content:encoded>
    </item>
  </channel>
</rss>
